# AWS IAM: ユーザー vs ロール 詳細比較

## 🎯 **基本的な違い**

| 項目             | IAM ユーザー                 | IAM ロール                     |
| ---------------- | ---------------------------- | ------------------------------ |
| **認証方式**     | 永続的なアクセスキー         | 一時的な STS トークン          |
| **有効期間**     | 永続的（手動更新まで）       | 短期間（通常 1 時間）          |
| **対象**         | 人間・長期アプリケーション   | AWS サービス・短期アクセス     |
| **セキュリティ** | リスク高（漏洩時の影響大）   | リスク低（自動ローテーション） |
| **管理負荷**     | 高（手動ローテーション必要） | 低（自動管理）                 |

---

## 🏗️ **それぞれの適用場面**

### ✅ **IAM ユーザーが適切な場合**

1. **ローカル開発環境**

    - Docker コンテナでの開発
    - 開発者の個人環境
    - CI/CD パイプライン

2. **AWS 外部での運用**

    - オンプレミスサーバー
    - 他クラウドプロバイダー
    - Heroku、Vercel 等の PaaS

3. **長期間の継続アクセス**
    - バッチ処理
    - 定期実行スクリプト
    - 第三者ツール連携

### ✅ **IAM ロールが適切な場合**

1. **AWS サービス上での運用**

    - EC2 インスタンス
    - ECS コンテナ
    - Lambda 関数
    - Elastic Beanstalk

2. **一時的なアクセス**
    - クロスアカウントアクセス
    - 外部 IdP 連携
    - 開発者の一時アクセス

---

## 🎯 **Roamory プロジェクトでの推奨戦略**

### **現在の状況分析**

```
✅ 現在: ローカル Docker 開発環境
✅ 今後: AWS 本番環境での運用予定
✅ 用途: SES メール送信機能
✅ 期間: 長期継続運用
```

### **段階的アプローチ（推奨）**

#### **Phase 1: 開発・テスト段階（現在）**

```
🎯 IAM ユーザー使用
理由:
- ローカル Docker 環境での開発
- AWS 外部からのアクセス
- 設定・テストの容易さ
- 一時的な使用
```

#### **Phase 2: 本番環境移行時**

```
🎯 IAM ロールへ移行
理由:
- EC2/ECS 等の AWS サービス上での運用
- セキュリティの向上
- 運用負荷の軽減
- AWS ベストプラクティス準拠
```

---

## 🔧 **具体的な実装方法**

### **Phase 1: IAM ユーザー設定（現在実行推奨）**

#### Step 1: IAM ユーザー作成

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "RoamorySESAccess",
            "Effect": "Allow",
            "Action": [
                "ses:SendEmail",
                "ses:SendRawEmail",
                "ses:GetSendQuota",
                "ses:GetSendStatistics"
            ],
            "Resource": "*"
        }
    ]
}
```

#### Step 2: Laravel 設定

```env
# 開発・テスト環境
MAIL_MAILER=ses
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=xxx...
AWS_DEFAULT_REGION=ap-northeast-1
```

### **Phase 2: IAM ロール設定（本番環境移行時）**

#### Step 1: EC2 インスタンスロール作成

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "ec2.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

#### Step 2: Laravel 設定（自動認証）

```env
# 本番環境（IAM ロール使用）
MAIL_MAILER=ses
# AWS_ACCESS_KEY_ID は不要（自動認証）
# AWS_SECRET_ACCESS_KEY は不要（自動認証）
AWS_DEFAULT_REGION=ap-northeast-1
```

---

## 🛡️ **セキュリティ比較**

### **IAM ユーザーのセキュリティリスク**

```
❌ 高リスク要素:
- 永続的なクレデンシャル
- 手動ローテーション必要
- 設定ファイルへの記載
- Git リポジトリ漏洩リスク
- 開発者間での共有リスク

⚠️ 対策:
- 環境変数での管理
- 定期的なローテーション
- 最小権限ポリシー
- アクセスログ監視
```

### **IAM ロールのセキュリティ優位性**

```
✅ 低リスク要素:
- 一時的なクレデンシャル
- 自動ローテーション
- AWS サービス統合
- 設定ファイル不要
- 監査ログ自動記録

✅ 追加メリット:
- AssumeRole による細かい制御
- 外部 IdP 連携可能
- クロスアカウントアクセス
- 条件付きアクセス制御
```

---

## 🚀 **移行戦略**

### **現在すべきこと（Phase 1）**

1. **IAM ユーザーで開発開始**

    - 迅速な開発・テスト実行
    - SES 機能の動作確認
    - メール認証フローの完成

2. **セキュリティベストプラクティス適用**
    - 最小権限ポリシー
    - 環境変数管理
    - 定期ローテーション計画

### **本番環境への移行準備（Phase 2）**

1. **インフラ設計時の考慮**

    - EC2/ECS での IAM ロール設計
    - インスタンスプロファイル設定
    - セキュリティグループ設定

2. **アプリケーション修正**
    - 環境検出ロジック
    - 認証方式の切り替え
    - エラーハンドリング改善

---

## 📋 **推奨アクション**

### **✅ 今すぐ実行（IAM ユーザー）**

```
理由: 開発・テスト段階での最適解
1. IAM ユーザー作成
2. SES テスト実行
3. 機能開発完了
4. セキュリティ設定強化
```

### **📅 将来実行（IAM ロール移行）**

```
タイミング: 本番インフラ構築時
1. EC2/ECS 環境設定
2. IAM ロール設計・作成
3. アプリケーション修正
4. 段階的移行実行
```

---

## 💡 **結論**

### **現在の最適解: IAM ユーザー**

-   ローカル開発環境に最適
-   迅速なテスト・検証可能
-   設定が簡単
-   セキュリティ対策も十分可能

### **将来の最適解: IAM ロール**

-   本番環境での標準
-   セキュリティ最高水準
-   運用負荷最小
-   AWS ベストプラクティス準拠

**結論**: 現段階では**IAM ユーザー**で進め、本番環境移行時に**IAM ロール**へ移行する段階的アプローチが最適です。
